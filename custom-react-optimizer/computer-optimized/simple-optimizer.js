#!/usr/bin/env node
const r=require,f=r('fs'),p=r('path'),a=r('@babel/parser'),t=r('@babel/traverse'),g=r('@babel/generator').default;
const c={
m:5*1024*1024,x:50,
i:{c:/^[A-Z]/,h:/^use[A-Z]/,f:/^[a-z]/,v:/^[a-zA-Z_$]/},
s:['React','useState','useEffect','useRef','window','document','console'],
e:[/React\./,/function\(/]
};
const v=(o,n,m)=>{const i=[],s=o.length,d=n.length,u=((s-d)/s)*100;if(u>c.x)i.push(`Too aggressive: ${u.toFixed(2)}%`);for(const e of c.e)if(!e.test(n))i.push(`Missing: ${e.source}`);const l=JSON.stringify(m).length;if(l>c.m)i.push(`Manifest too large: ${(l/1024).toFixed(2)}KB`);return{issues:i,reduction:u}};
const w=(n,x,y,z)=>c.s.includes(n)||n.length<=3||['Object','Array','String'].includes(n)?false:Object.values(c.i).some(e=>e.test(n));
const b=d=>{try{console.log('🚀 Computer-Optimized Stripper');const h=d||p.join(__dirname,'../build/static/js'),l=f.readdirSync(h).find(e=>e.startsWith('main.')&&e.endsWith('.js')&&!e.includes('stripped'));if(!l)throw new Error('Main bundle not found');const j=p.join(h,l),k=f.readFileSync(j,'utf-8'),q=k.length;console.log(`📦 Original: ${(q/1024).toFixed(2)}KB`);const s=a.parse(k,{sourceType:'module',plugins:['jsx']}),m={},u={identifiers:0,strings:0,numbers:0};let i=0;t.default(s,{Identifier(e){const n=e.node.name;if(m[n]||!w(n))return;const o=`x${i++}`;m[o]=n;e.node.name=o;u.identifiers++;},StringLiteral(e){const n=e.node.value;if(n.length<8)return;const o=`s${u.strings++}`;m[o]=n;e.node.value=o;},NumericLiteral(e){const n=e.node.value;if(n<1000)return;const o=`n${u.numbers++}`;m[o]=n;e.node.value=o;}});const n=g.default(s,{minified:true,compact:true,comments:false}).code,z=v(k,n,m);if(z.issues.length>0){console.log('❌ Validation failed:',z.issues.join(', '));return{success:false,error:z.issues.join(', ')};}const o=p.join(h,l.replace('.js','.computer-optimized.js')),y=p.join(p.dirname(h),'computer-optimization-manifest.json');f.writeFileSync(o,n);f.writeFileSync(y,JSON.stringify(m,null,2));console.log('✅ Computer Optimization Complete!');console.log(`📦 Original: ${(q/1024).toFixed(2)}KB`);console.log(`🔥 Optimized: ${(n.length/1024).toFixed(2)}KB`);console.log(`📉 Reduction: ${z.reduction.toFixed(2)}%`);console.log(`🔧 Total: ${u.identifiers+u.strings+u.numbers} optimizations`);console.log(`📊 Manifest: ${(JSON.stringify(m).length/1024).toFixed(2)}KB`);return{success:true,originalSize:q,optimizedSize:n.length,reduction:z.reduction,totalOptimizations:u.identifiers+u.strings+u.numbers,manifestSize:JSON.stringify(m).length,optimizedBundlePath:o,manifestPath:y};}catch(e){console.error('❌ Computer optimization failed:',e.message);return{success:false,error:e.message};}};
if(require.main===module){const result=b();if(result.success){console.log('\n✅ Computer optimization completed!');process.exit(0);}else{console.log('\n❌ Computer optimization failed!');process.exit(1);}}
module.exports={optimizeBundle:b};
